#!/usr/bin/env bash

if [ -n "$1" ]; then
  npm_test_exit_code=$1
fi

fail=0
if [ -z "$CS_PROJECT_ACCESS_TOKEN" ]; then
  echo "Error: missing CS_PROJECT_ACCESS_TOKEN from CucumberStudio project to push results"
  fail=1
fi
if [ -z "$REPOSITORY_NAME" ]; then
  echo "Error: missing REPOSITORY_NAME from CucumberStudio project to push results"
  fail=1
fi

[ $fail == 1 ] && exit 1

if [ -z "$COMMIT_HASH" ]; then
  echo "Warning: missing COMMIT_HASH from CucumberStudio project to push results"
  export COMMIT_HASH=$(git rev-parse HEAD)
  echo "COMMIT_HASH set to current HEAD ($COMMIT_HASH)"
fi

if [ -z "$COMMIT_BRANCH" -a -n "$GITHUB_REF" ]; then
  export COMMIT_BRANCH="${GITHUB_REF##*/}"
fi

if [ -z "$COMMIT_BRANCH" ]; then
  echo "Warning: missing COMMIT_BRANCH from CucumberStudio project to push results"
  export COMMIT_BRANCH=$(git rev-parse --abbrev-ref $COMMIT_HASH)
  echo "COMMIT_BRANCH set to current HEAD ($COMMIT_BRANCH)"
fi

set -x
curl \
  -X POST \
  https://studio.cucumber.io/cucumber_project/results \
  -F messages=@messages.ndjson \
  -H "project-access-token: $CS_PROJECT_ACCESS_TOKEN" \
  -H "provider: github" \
  -H "repo: $REPOSITORY_NAME" \
  -H "branch: $COMMIT_BRANCH" \
  -H "revision: $COMMIT_HASH"
{ set +x; } 2>/dev/null
echo

if [ -n "$npm_test_exit_code" ]; then
  exit $npm_test_exit_code
fi
